@page "/animal-info"
@using Savanna.Web.Services.Interfaces
@using Savanna.Web.Constants
@using Savanna.Domain.Interfaces
@using Savanna.Web.Services
@using System.Reflection
@using System.Text.Json
@using Savanna.Core.Constants
@using Microsoft.AspNetCore.Components.Web
@using Savanna.Core.Config

@inject IPluginService PluginService
@inject IGameService GameService
@inject ILogger<AnimalInformation> Logger
@inject NavigationManager NavigationManager
@rendermode InteractiveServer

<PageTitle>Animal Information</PageTitle>

<div class="savanna-container">
    <h1>Animal Information</h1>

    <div class="table-responsive">
        <table class="savanna-table">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Type</th>
                    <th>Source</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Lion</td>
                    <td><span class="animal-badge predator">Predator</span></td>
                    <td>Savanna.Core</td>
                    <td>
                        <button type="button" class="btn-savanna btn-primary"
                            @onclick="() => ViewDefaultAnimalDetails(GameConstants.LionName)">
                            <i class="bi bi-info-circle me-1"></i> Details
                        </button>
                    </td>
                </tr>
                <tr>
                    <td>Antelope</td>
                    <td><span class="animal-badge prey">Prey</span></td>
                    <td>Savanna.Core</td>
                    <td>
                        <button type="button" class="btn-savanna btn-primary"
                            @onclick="() => ViewDefaultAnimalDetails(GameConstants.AntelopeName)">
                            <i class="bi bi-info-circle me-1"></i> Details
                        </button>
                    </td>
                </tr>

                @foreach (var animalName in _availableAnimals)
                {
                    var info = PluginService.GetPluginAnimalInfo(animalName);
                    <tr>
                        <td>@info.Name</td>
                        <td>
                            @if (info.IsPredator)
                            {
                                <span class="animal-badge predator">Predator</span>
                            }
                            else if (info.IsPrey)
                            {
                                <span class="animal-badge prey">Prey</span>
                            }
                            else
                            {
                                <span class="animal-badge neutral">Unknown</span>
                            }
                        </td>
                        <td>@info.SourceAssembly</td>
                        <td>
                            <button type="button" class="btn-savanna btn-primary"
                                @onclick="() => ViewAnimalDetails(animalName)">
                                <i class="bi bi-info-circle me-1"></i> Details
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

@if (_showAnimalDetailsModal)
{
    <div class="savanna-modal-overlay">
        <div class="savanna-modal">
            <div class="savanna-modal-content">
                <div class="savanna-modal-header">
                    <h5 class="savanna-modal-title">@_selectedAnimal?.Name Details</h5>
                    <button type="button" class="savanna-modal-close" @onclick="CloseModal">
                        <i class="bi bi-x-lg"></i>
                    </button>
                </div>
                <div class="savanna-modal-body">
                    <div class="code-container">
                        <div class="code-header">JSON Representation</div>
                        <pre class="code-content"><code>@_selectedAnimalJson</code></pre>
                    </div>
                </div>
                <div class="savanna-modal-footer">
                    <button type="button" class="btn-savanna btn-secondary" @onclick="CloseModal">Close</button>
                </div>
            </div>
        </div>
    </div>
}

@if (!string.IsNullOrEmpty(_statusMessage))
{
    <div class="savanna-toast-container">
        <div class="savanna-toast @_statusMessageClass">
            <div class="savanna-toast-header">
                <strong>@_statusMessageTitle</strong>
                <button type="button" class="savanna-toast-close" @onclick="() => _statusMessage = null">
                    <i class="bi bi-x"></i>
                </button>
            </div>
            <div class="savanna-toast-body">
                @_statusMessage
            </div>
        </div>
    </div>
}

<style>
    .savanna-container {
        background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%239e9764' fill-opacity='0.1'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E"),
            linear-gradient(135deg, var(--savanna-sand) 0%, var(--secondary-bg) 100%);
        border-radius: var(--border-radius);
        box-shadow: var(--card-shadow);
        padding: 2rem;
        margin: 2rem auto;
        position: relative;
        overflow: hidden;
    }

    .savanna-container::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 5px;
        background: linear-gradient(to right, var(--savanna-accent), var(--savanna-grass), var(--savanna-accent));
    }

    .savanna-container h1 {
        text-align: center;
        margin-bottom: 1.5rem;
        margin-top: 1rem;
        color: var(--savanna-earth);
        font-weight: 700;
        font-size: 2.2rem;
    }

    .savanna-card {
        background-color: var(--panel-bg);
        border-radius: var(--border-radius);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .savanna-card h4 {
        color: var(--savanna-earth);
        font-weight: 600;
    }

    .savanna-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        background-color: rgba(255, 253, 245, 0.7);
        border-radius: var(--border-radius);
        overflow: hidden;
    }

    .savanna-table th {
        background-color: var(--savanna-sand);
        color: var(--savanna-earth);
        font-weight: 600;
        padding: 0.75rem 1rem;
        text-align: left;
        border-bottom: 2px solid var(--savanna-accent);
    }

    .savanna-table td {
        padding: 0.75rem 1rem;
        border-bottom: 1px solid var(--savanna-sand);
        vertical-align: middle;
    }

    .savanna-table tr:nth-child(even) {
        background-color: rgba(246, 240, 227, 0.7);
    }

    .savanna-table tr:nth-child(odd) {
        background-color: rgba(254, 250, 240, 0.7);
    }

    .savanna-table tr:hover {
        background-color: rgba(194, 112, 61, 0.1);
    }

    .animal-badge {
        display: inline-block;
        padding: 0.35em 0.65em;
        font-size: 0.75em;
        font-weight: 600;
        border-radius: 0.25rem;
        text-align: center;
        white-space: nowrap;
    }

    .predator {
        background-color: rgba(220, 53, 69, 0.2);
        color: #b02a37;
    }

    .prey {
        background-color: rgba(25, 135, 84, 0.2);
        color: #146c43;
    }

    .neutral {
        background-color: rgba(108, 117, 125, 0.2);
        color: #495057;
    }

    .btn-savanna {
        display: inline-flex;
        align-items: center;
        padding: 0.375rem 0.75rem;
        font-size: 0.875rem;
        font-weight: 500;
        border-radius: var(--border-radius);
        cursor: pointer;
        transition: all var(--transition-speed);
        border: none;
    }

    .btn-primary {
        background-color: var(--savanna-accent);
        color: white;
    }

    .btn-primary:hover {
        background-color: var(--savanna-accent-dark, #b85c36);
    }

    .btn-secondary {
        background-color: var(--secondary-bg);
        color: var(--secondary-text);
    }

    .btn-secondary:hover {
        background-color: #e2e2e2;
    }

    .savanna-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1050;
    }

    .savanna-modal {
        width: 100%;
        max-width: 700px;
        margin: 1.75rem;
    }

    .savanna-modal-content {
        background-color: var(--panel-bg);
        border-radius: var(--border-radius);
        box-shadow: var(--card-shadow);
        display: flex;
        flex-direction: column;
        position: relative;
        overflow: hidden;
    }

    .savanna-modal-content::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(to right, var(--savanna-accent), var(--savanna-grass), var(--savanna-accent));
    }

    .savanna-modal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 1rem 1.5rem;
        border-bottom: 1px solid var(--savanna-sand-light);
    }

    .savanna-modal-title {
        margin: 0;
        color: var(--savanna-earth);
        font-weight: 600;
    }

    .savanna-modal-close {
        background: transparent;
        border: none;
        font-size: 1.25rem;
        color: var(--secondary-text);
        cursor: pointer;
        padding: 0;
    }

    .savanna-modal-close:hover {
        color: var(--savanna-earth);
    }

    .savanna-modal-body {
        padding: 1.5rem;
    }

    .savanna-modal-footer {
        padding: 1rem 1.5rem;
        border-top: 1px solid var(--savanna-sand-light);
        display: flex;
        justify-content: flex-end;
    }

    .code-container {
        background-color: var(--savanna-sand-light);
        border-radius: var(--border-radius);
        overflow: hidden;
    }

    .code-header {
        background-color: var(--savanna-sand);
        color: var(--savanna-earth);
        padding: 0.5rem 1rem;
        font-weight: 600;
        font-size: 0.875rem;
    }

    .code-content {
        background-color: #272822;
        color: #f8f8f2;
        padding: 1rem;
        margin: 0;
        border-radius: 0 0 var(--border-radius) var(--border-radius);
        max-height: 400px;
        overflow: auto;
    }

    .savanna-toast-container {
        position: fixed;
        bottom: 1rem;
        right: 1rem;
        z-index: 1100;
    }

    .savanna-toast {
        background-color: var(--panel-bg);
        border-radius: var(--border-radius);
        box-shadow: var(--card-shadow);
        width: 350px;
        margin-top: 0.5rem;
        overflow: hidden;
    }

    .savanna-toast.bg-danger {
        border-left: 4px solid var(--danger);
    }

    .savanna-toast.bg-success {
        border-left: 4px solid var(--savanna-grass);
    }

    .savanna-toast-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.5rem 1rem;
        background-color: var(--savanna-sand-light);
        border-bottom: 1px solid var(--savanna-sand);
    }

    .savanna-toast-body {
        padding: 1rem;
    }

    .savanna-toast-close {
        background: transparent;
        border: none;
        color: var(--secondary-text);
        cursor: pointer;
        padding: 0;
    }
</style>

@code {
    private List<string> _availableAnimals = new();
    private PluginAnimalInfo? _selectedAnimal;
    private string _selectedAnimalJson = "{}";
    private string? _statusMessage;
    private string _statusMessageClass = "";
    private string _statusMessageTitle = "";
    private bool _showAnimalDetailsModal = false;
    private string? _selectedDefaultAnimal;

    protected override void OnInitialized()
    {
        try
        {
            _availableAnimals = PluginService.GetAvailablePluginAnimals().ToList();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading plugin animals");
            _statusMessage = $"Error loading plugin animals: {ex.Message}";
            _statusMessageClass = "bg-danger text-white";
            _statusMessageTitle = "Error";
        }
    }

    private void ViewAnimalDetails(string animalName)
    {
        try
        {
            _selectedAnimal = PluginService.GetPluginAnimalInfo(animalName);
            _selectedAnimalJson = JsonSerializer.Serialize(_selectedAnimal, new JsonSerializerOptions { WriteIndented = true });
            _showAnimalDetailsModal = true;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading animal details for {AnimalName}", animalName);
            _statusMessage = $"Error loading animal details: {ex.Message}";
            _statusMessageClass = "bg-danger text-white";
            _statusMessageTitle = "Error";
        }
    }

    private void ViewDefaultAnimalDetails(string animalName)
    {
        try
        {
            _selectedDefaultAnimal = animalName;
            _selectedAnimal = GetDefaultAnimalInfo(animalName);
            _selectedAnimalJson = JsonSerializer.Serialize(_selectedAnimal, new JsonSerializerOptions { WriteIndented = true });
            _showAnimalDetailsModal = true;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading default animal details for {AnimalName}", animalName);
            _statusMessage = $"Error loading animal details: {ex.Message}";
            _statusMessageClass = "bg-danger text-white";
            _statusMessageTitle = "Error";
        }
    }

    private PluginAnimalInfo GetDefaultAnimalInfo(string animalName)
    {
        var animalConfig = ConfigurationService.GetAnimalConfig(animalName);

        var defaultAnimalInfo = new PluginAnimalInfo
        {
            Name = animalName,
            AnimalType = animalName,
            SourceAssembly = "Savanna.Core",
            IsPredator = animalConfig.Predator != null,
            IsPrey = animalConfig.Prey != null,
            Speed = animalConfig.Speed,
            VisionRange = animalConfig.VisionRange,
            SpecialActionChance = animalConfig.SpecialActionChance
        };

        if (animalConfig.Predator != null)
        {
            defaultAnimalInfo.HuntingRange = animalConfig.Predator.HuntingRange;
            defaultAnimalInfo.HealthGainFromKill = animalConfig.Predator.HealthGainFromKill;

            if (animalConfig.Predator.RoarRange > 0)
            {
                defaultAnimalInfo.RoarRange = animalConfig.Predator.RoarRange;
            }
        }

        if (animalConfig.Prey != null)
        {
            defaultAnimalInfo.HealthFromGrazing = animalConfig.Prey.HealthFromGrazing;
        }

        return defaultAnimalInfo;
    }

    private void CloseModal()
    {
        _showAnimalDetailsModal = false;
        _selectedAnimal = null;
        _selectedDefaultAnimal = null;
        StateHasChanged();
    }
}